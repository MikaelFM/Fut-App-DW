<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha512-MV7K8+y+gLIBoVD59lQIYicR65iaqukzvf/nwasF0nqhPay5w/9lJmVM2hMDcnK1OnMGCdVK+iQrJ7lzPJQd1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/users.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.3.min.js" integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.7.14/dist/vue.js"></script>
</head>
<body>
    <div id="tudo">
        <h1 onclick="window.location.href = '/'">Players</h1>
        <div class="accordion accordion-flush" v-for="(pessoa, key) in data">
            <div class="accordion-item">
                <h2 class="accordion-header" :id="'flush-heading'+ key">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" :data-bs-target="'#flush-collapse' + key" aria-expanded="false" :aria-controls="'flush-collapse' + key">
                        <input type="text" v-model="pessoa.nome">
                    </button>
                </h2>
                <div :id="'flush-collapse' + key" class="accordion-collapse collapse" :aria-labelledby="'flush-heading' + key" data-bs-parent="#accordionFlushExample">
                    <table v-if="pessoa.dividas.length > 0">
                        <tbody>
                            <tr v-for="(divida, indexDivida) in pessoa.dividas">
                                <td class="data">[[divida.data]]</td>
                                <td class="valor"><span>R$</span><input type="text" @blur="resoma(key)" class="dividaInput" v-model="divida.valor"></td>
                                <td class="icon" @click="remove(key, indexDivida)"><i class="fa-solid fa-trash"></i></td>
                            </tr>
                            <tr class="totalize">
                                <td class="label">TOTAL:</td>
                                <td class="valor">R$<input class="totalizeInput" type="text" v-model="pessoa.total"></td>
                                <td><i class="fa-solid fa-circle-check" @click="removeAll(key)"></i></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <button class="button" @click="submit()">CONFIRMAR</button>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
    <script>
        let dados = {{data|tojson}};
        const App = new Vue({
            el: '#tudo',
            delimiters: ['[[', ']]'],
            data: {
                data: dados
            },
            methods: {
                submit: function(){
                    $.post('/updateUsers', {
                        dados: JSON.stringify(this.data)
                    }, 
                    function(returnedData){ 
                        console.log(returnedData);
                        window.location.href = '/'
                    })
                },
                resoma: function(index){
                    total = 0;
                    this.data[index].dividas.forEach(element => total += parseFloat(element.valor.replace(',', '.')));
                    this.data[index].total = total.toFixed(2);
                },
                remove: function(indexPessoa, indexDivida){
                    this.data[indexPessoa].dividas.splice(indexDivida, 1);
                    this.resoma(indexPessoa);
                },
                removeAll: function(index){
                    this.data[index].dividas = [];
                    this.data[index].total = 0.0;
                }
            }
        })
    </script>
</body>
</html>